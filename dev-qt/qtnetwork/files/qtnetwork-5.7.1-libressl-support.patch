From 7a91a0893f86e678bcf3738c3a25ac1eb550ab7d Mon Sep 17 00:00:00 2001
From: Luigi 'Comio' Mantellini <luigi.mantellini@gmail.com>
Date: Tue, 13 Dec 2016 15:55:59 +0100
Subject: [PATCH] Fix build with LibreSSL

---
 config.tests/unix/openssl/openssl.cpp          | 2 ++
 src/network/ssl/qsslcontext_openssl.cpp        | 4 ++++
 src/network/ssl/qsslsocket_openssl.cpp         | 2 +-
 src/network/ssl/qsslsocket_openssl_symbols_p.h | 6 +++++-
 4 files changed, 12 insertions(+), 2 deletions(-)

diff --git a/config.tests/unix/openssl/openssl.cpp b/config.tests/unix/openssl/openssl.cpp
index 860567e..788e729 100644
--- a/config.tests/unix/openssl/openssl.cpp
+++ b/config.tests/unix/openssl/openssl.cpp
@@ -39,9 +39,11 @@
 
 #include <openssl/opensslv.h>
 
+#ifndef LIBRESSL_VERSION_NUMBER
 #if !defined(OPENSSL_VERSION_NUMBER) || OPENSSL_VERSION_NUMBER-0 < 0x0090700fL
 #  error "OpenSSL >= 0.9.7 is required"
 #endif
+#endif
 
 int main()
 {
diff --git a/src/network/ssl/qsslcontext_openssl.cpp b/src/network/ssl/qsslcontext_openssl.cpp
index f132d02..c28e022 100644
--- a/src/network/ssl/qsslcontext_openssl.cpp
+++ b/src/network/ssl/qsslcontext_openssl.cpp
@@ -49,6 +49,10 @@
 #include "private/qsslsocket_openssl_p.h"
 #include "private/qsslsocket_openssl_symbols_p.h"
 
+#if defined(LIBRESSL_VERSION_NUMBER) && !defined(OPENSSL_NO_EC)
+#define OPENSSL_NO_EC
+#endif
+
 QT_BEGIN_NAMESPACE
 
 // defined in qsslsocket_openssl.cpp:
diff --git a/src/network/ssl/qsslsocket_openssl.cpp b/src/network/ssl/qsslsocket_openssl.cpp
index c6d63ad..2b8b3b5 100644
--- a/src/network/ssl/qsslsocket_openssl.cpp
+++ b/src/network/ssl/qsslsocket_openssl.cpp
@@ -1578,7 +1578,7 @@ void QSslSocketBackendPrivate::continueHandshake()
     }
 #endif // OPENSSL_VERSION_NUMBER >= 0x1000100fL ...
 
-#if OPENSSL_VERSION_NUMBER >= 0x10002000L
+#if OPENSSL_VERSION_NUMBER >= 0x10002000L && !defined(LIBRESSL_VERSION_NUMBER)
     if (q_SSLeay() >= 0x10002000L && mode == QSslSocket::SslClientMode) {
         EVP_PKEY *key;
         if (q_SSL_get_server_tmp_key(ssl, &key))
diff --git a/src/network/ssl/qsslsocket_openssl_symbols_p.h b/src/network/ssl/qsslsocket_openssl_symbols_p.h
index 36e041b..9f405b1 100644
--- a/src/network/ssl/qsslsocket_openssl_symbols_p.h
+++ b/src/network/ssl/qsslsocket_openssl_symbols_p.h
@@ -70,6 +70,10 @@
 #include "qsslsocket_openssl_p.h"
 #include <QtCore/qglobal.h>
 
+#if defined(LIBRESSL_VERSION_NUMBER) && !defined(OPENSSL_NO_EC)
+#define OPENSSL_NO_EC
+#endif
+
 QT_BEGIN_NAMESPACE
 
 #define DUMMYARG
@@ -489,7 +493,7 @@ size_t q_EC_get_builtin_curves(EC_builtin_curve *r, size_t nitems);
 int q_EC_curve_nist2nid(const char *name);
 #endif // OPENSSL_VERSION_NUMBER >= 0x10002000L
 #endif // OPENSSL_NO_EC
-#if OPENSSL_VERSION_NUMBER >= 0x10002000L
+#if OPENSSL_VERSION_NUMBER >= 0x10002000L && !defined(LIBRESSL_VERSION_NUMBER)
 #define q_SSL_get_server_tmp_key(ssl, key) q_SSL_ctrl((ssl), SSL_CTRL_GET_SERVER_TMP_KEY, 0, (char *)key)
 #endif // OPENSSL_VERSION_NUMBER >= 0x10002000L
 
--- ./config.tests/unix/openssl/openssl.cpp.old	2016-10-15 17:08:36.432115188 +0200
+++ ./config.tests/unix/openssl/openssl.cpp	2016-10-15 17:09:48.628278503 +0200
@@ -39,9 +39,11 @@
 
 #include <openssl/ssl.h>
 
+#ifndef LIBRESSL_VERSION_NUMBER
 #if OPENSSL_VERSION_NUMBER-0 >= 0x10002000L && !defined(OPENSSL_NO_EC) && !defined(SSL_CTRL_SET_CURVES)
 #  error "OpenSSL was reported as >= 1.0.2 but is missing required features, possibly it's libressl which is unsupported"
 #endif
+#endif
 
 int main()
 {
-- 
2.11.0

